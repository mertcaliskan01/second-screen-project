<!DOCTYPE html>
<html lang="tr">
  <head>
    <meta charset="UTF-8" />
    <title>Mac Ekran YayÄ±nlayÄ±cÄ±</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
      body {
        font-family: sans-serif;
        text-align: center;
        margin-top: 50px;
      }
      #localVideo {
        width: 400px;
        height: auto;
        border: 2px solid #333;
        margin-top: 20px;
      }
    </style>
  </head>
  <body>
    <h1>Mac M1 - Ekran YayÄ±nlayÄ±cÄ±</h1>
    <p>
      YayÄ±nÄ± baÅŸlatmak iÃ§in lÃ¼tfen aÅŸaÄŸÄ±daki dÃ¼ÄŸmeye tÄ±klayÄ±n ve ekranÄ±nÄ±zÄ±
      seÃ§in.
    </p>
    <button id="startButton">Ekran YayÄ±nÄ±nÄ± BaÅŸlat</button>
    <p id="status">BaÄŸlantÄ± bekleniyor...</p>

    <video id="localVideo" autoplay playsinline muted></video>

    <script>
      // ğŸš¨ CHANGE THIS TO YOUR MAC IP ADDRESS
      const MAC_IP_ADDRESS = "";
      const PEER_SERVER_PORT = 9000;

      const statusEl = document.getElementById("status");
      const startButton = document.getElementById("startButton");

      startButton.addEventListener("click", startStream);

      let peer = null;
      let currentStream = null;

      function initializePeer() {
        statusEl.textContent = "Connecting to PeerJS server...";

        peer = new Peer("streamer-mac-m1", {
          // Fixed ID for streamer
          host: MAC_IP_ADDRESS,
          port: PEER_SERVER_PORT,
          path: "/myapp",
        });

        peer.on("open", (id) => {
          statusEl.textContent = `Ready! ID: ${id}. Waiting for Windows laptop to connect.`;
          console.log("Peer connection established. ID:", id);
        });

        // Set up call listener immediately when peer is ready
        peer.on("call", (call) => {
          console.log("Incoming call received");
          if (currentStream) {
            console.log("Current stream details:", {
              id: currentStream.id,
              active: currentStream.active,
              videoTracks: currentStream.getVideoTracks().length,
              audioTracks: currentStream.getAudioTracks().length,
            });

            const videoTracks = currentStream.getVideoTracks();
            if (videoTracks.length > 0) {
              console.log("Video track:", {
                label: videoTracks[0].label,
                enabled: videoTracks[0].enabled,
                muted: videoTracks[0].muted,
                readyState: videoTracks[0].readyState,
              });
            }

            call.answer(currentStream); // Send video stream as answer to the call
            statusEl.textContent =
              "Viewer connected and your screen is being shared!";
            console.log("Answering call with stream");
          } else {
            console.warn(
              "Call received but no stream available. Please start screen sharing first."
            );
            statusEl.textContent =
              "Call received but screen sharing not started. Click 'Start' button first.";
          }
        });

        peer.on("error", (err) => {
          console.error("PeerJS Error:", err);
          statusEl.textContent = `Error: Could not connect to PeerJS server. Check IP and port.`;
        });
      }

      async function startStream() {
        startButton.disabled = true;
        statusEl.textContent = "Requesting screen sharing permission...";

        try {
          // 1. Get screen capture stream
          const stream = await navigator.mediaDevices.getDisplayMedia({
            video: true,
            audio: false,
          });
          currentStream = stream;
          document.getElementById("localVideo").srcObject = stream;
          statusEl.textContent =
            "Screen captured. Ready to share! Waiting for viewer connection...";
          console.log("Screen stream captured successfully");

          // Handle stream end (user stops sharing)
          stream.getVideoTracks()[0].onended = () => {
            statusEl.textContent = "Screen sharing stopped.";
            currentStream = null;
            startButton.disabled = false;
          };
        } catch (err) {
          console.error("Screen capture error:", err);
          statusEl.textContent = `Error: Screen could not be captured or permission denied. Please try again.`;
          startButton.disabled = false;
        }
      }

      initializePeer();
    </script>
  </body>
</html>
